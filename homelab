#!/bin/bash
set -e

# Homelab CLI - Heroku-like interface for Dokku
# Usage: homelab <command> [args]

DOKKU_HOST="dokku"  # SSH config alias
DOKKU_DOMAIN="${DOKKU_DOMAIN:-nate.green}"

# Resolve symlinks to find the actual script location
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$SCRIPT_DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Auto-detect app name from git remote
detect_app() {
    if git remote -v 2>/dev/null | grep -q "dokku:"; then
        git remote -v | grep "dokku:" | head -1 | sed 's/.*dokku:\([^[:space:]]*\).*/\1/'
    fi
}

# Require app name (use detected or error)
require_app() {
    local app="${1:-$(detect_app)}"
    if [[ -z "$app" ]]; then
        echo -e "${RED}Error: No app specified and none detected from git remote${NC}" >&2
        echo "Usage: homelab $COMMAND <app-name>" >&2
        echo "Or run from a repo with a dokku remote" >&2
        exit 1
    fi
    echo "$app"
}

# Check if running on the server (marker file created by install.sh)
is_server() {
    [[ -f "$SCRIPT_DIR/.homelab-server" ]]
}

# Warn and confirm if a server-only command is run on a client
require_server() {
    if ! is_server; then
        echo -e "${YELLOW}Warning: '$COMMAND' is a server-only command${NC}" >&2
        echo "This command should be run on the homelab server, not a client machine." >&2
        read -p "Continue anyway? [y/N] " CONFIRM
        [[ "$CONFIRM" =~ ^[yY]$ ]] || exit 1
    fi
}

# Print app URL (https if certs are set up)
app_url() {
    local app="$1"
    if [[ -f "$SCRIPT_DIR/dokku/certs/server.crt" ]]; then
        echo "https://${app}.homelab.${DOKKU_DOMAIN}"
    else
        echo "http://${app}.homelab.${DOKKU_DOMAIN}"
    fi
}

COMMAND="${1:-help}"

case "$COMMAND" in
    apps|list)
        # List all apps
        echo -e "${CYAN}Apps on homelab:${NC}"
        ssh "$DOKKU_HOST" apps:list | tail -n +2
        ;;

    create)
        # Create a new app
        APP="${2:?Error: app name required}"
        echo -e "${CYAN}Creating app '$APP'...${NC}"
        ssh "$DOKKU_HOST" apps:create "$APP"
        ssh "$DOKKU_HOST" domains:set "$APP" "${APP}.homelab.${DOKKU_DOMAIN}"

        # Auto-enable HTTPS if certs are available
        CERT_DIR="$SCRIPT_DIR/dokku/certs"
        if [[ -f "$CERT_DIR/server.crt" ]]; then
            echo -e "${CYAN}Enabling HTTPS...${NC}"
            cd "$CERT_DIR"
            tar cf - server.crt server.key | docker exec -i dokku dokku certs:add "$APP" 2>&1 | grep -v "^a " || true
        fi

        # Add git remote if in a git repo
        if git rev-parse --git-dir >/dev/null 2>&1; then
            if git remote | grep -q "^dokku$"; then
                git remote set-url dokku "dokku:$APP"
                echo -e "${YELLOW}Updated existing 'dokku' remote${NC}"
            else
                git remote add dokku "dokku:$APP"
                echo -e "${GREEN}Added 'dokku' git remote${NC}"
            fi
        fi

        echo -e "${GREEN}App created!${NC} Deploy with: ${CYAN}homelab deploy${NC}"
        echo -e "URL: $(app_url "$APP")"
        ;;

    deploy|push)
        # Deploy app (create if --create flag)
        shift
        CREATE=false
        APP=""
        BRANCH="main"

        while [[ $# -gt 0 ]]; do
            case "$1" in
                --create|-c) CREATE=true; shift ;;
                --branch|-b) BRANCH="$2"; shift 2 ;;
                *) APP="$1"; shift ;;
            esac
        done

        APP=$(require_app "$APP")

        # Check if in git repo
        if ! git rev-parse --git-dir >/dev/null 2>&1; then
            echo -e "${RED}Error: Not in a git repository${NC}" >&2
            exit 1
        fi

        # Check for uncommitted changes
        if ! git diff-index --quiet HEAD -- 2>/dev/null; then
            echo -e "${YELLOW}Warning: You have uncommitted changes${NC}"
        fi

        # Create app if requested
        if [[ "$CREATE" == true ]]; then
            if ssh "$DOKKU_HOST" apps:exists "$APP" 2>/dev/null; then
                echo -e "${YELLOW}App '$APP' already exists, deploying...${NC}"
            else
                echo -e "${CYAN}Creating app '$APP'...${NC}"
                ssh "$DOKKU_HOST" apps:create "$APP"
                ssh "$DOKKU_HOST" domains:set "$APP" "${APP}.homelab.${DOKKU_DOMAIN}"
            fi
        fi

        # Ensure git remote exists
        if ! git remote | grep -q "^dokku$"; then
            git remote add dokku "dokku:$APP"
            echo -e "${GREEN}Added 'dokku' git remote${NC}"
        fi

        # Deploy
        echo -e "${CYAN}Deploying '$APP' from branch '$BRANCH'...${NC}"
        git push dokku "$BRANCH:main"

        echo -e "\n${GREEN}Deployed!${NC} $(app_url "$APP")"
        ;;

    logs)
        # View app logs
        shift
        TAIL=false
        APP=""

        while [[ $# -gt 0 ]]; do
            case "$1" in
                -t|--tail|-f) TAIL=true; shift ;;
                *) APP="$1"; shift ;;
            esac
        done

        APP=$(require_app "$APP")

        if [[ "$TAIL" == true ]]; then
            ssh "$DOKKU_HOST" logs "$APP" -t
        else
            ssh "$DOKKU_HOST" logs "$APP"
        fi
        ;;

    config)
        # Show/manage config
        shift
        APP=$(require_app "$1")
        echo -e "${CYAN}Config for '$APP':${NC}"
        ssh "$DOKKU_HOST" config:show "$APP"
        ;;

    config:set)
        # Set config vars
        shift
        APP="${1:?Error: app name required}"
        shift
        [[ $# -eq 0 ]] && { echo "Usage: homelab config:set <app> KEY=value [KEY=value ...]"; exit 1; }

        echo -e "${CYAN}Setting config for '$APP'...${NC}"
        ssh "$DOKKU_HOST" config:set "$APP" "$@"
        ;;

    config:unset)
        # Unset config vars
        shift
        APP="${1:?Error: app name required}"
        shift
        [[ $# -eq 0 ]] && { echo "Usage: homelab config:unset <app> KEY [KEY ...]"; exit 1; }

        echo -e "${CYAN}Unsetting config for '$APP'...${NC}"
        ssh "$DOKKU_HOST" config:unset "$APP" "$@"
        ;;

    # =========================================================================
    # Build Configuration (for static sites that need build-time env vars)
    # =========================================================================
    build-args)
        # List build args for an app
        shift
        APP=$(require_app "$1")
        echo -e "${CYAN}Build args for '$APP':${NC}"
        ssh "$DOKKU_HOST" docker-options:report "$APP" | grep -E "build|Build" || echo "  (none)"
        ;;

    build-args:set)
        # Add build arg (pulls from config var)
        shift
        APP="${1:?Error: app name required}"
        shift
        [[ $# -eq 0 ]] && { echo "Usage: homelab build-args:set <app> KEY [KEY ...]"; exit 1; }

        echo -e "${CYAN}Adding build args for '$APP'...${NC}"
        for KEY in "$@"; do
            # Strip =value if provided (we just need the key name)
            KEY="${KEY%%=*}"
            ssh "$DOKKU_HOST" docker-options:add "$APP" build "--build-arg $KEY"
            echo -e "  ${GREEN}✓${NC} $KEY"
        done
        echo ""
        echo -e "${YELLOW}Note:${NC} Make sure config var is set: homelab config:set $APP $KEY=value"
        echo "Then rebuild: homelab rebuild $APP"
        ;;

    build-args:unset)
        # Remove build arg
        shift
        APP="${1:?Error: app name required}"
        shift
        [[ $# -eq 0 ]] && { echo "Usage: homelab build-args:unset <app> KEY [KEY ...]"; exit 1; }

        echo -e "${CYAN}Removing build args for '$APP'...${NC}"
        for KEY in "$@"; do
            ssh "$DOKKU_HOST" docker-options:remove "$APP" build "--build-arg $KEY" 2>/dev/null || true
            echo -e "  ${GREEN}✓${NC} $KEY removed"
        done
        ;;

    rebuild)
        # Force rebuild an app
        shift
        NO_CACHE=false
        APP=""

        while [[ $# -gt 0 ]]; do
            case "$1" in
                --no-cache) NO_CACHE=true; shift ;;
                *) APP="$1"; shift ;;
            esac
        done

        APP=$(require_app "$APP")

        if [[ "$NO_CACHE" == true ]]; then
            echo -e "${CYAN}Rebuilding '$APP' (busting cache)...${NC}"
            # Clear build cache then rebuild
            ssh "$DOKKU_HOST" repo:purge-cache "$APP" 2>/dev/null || true
            ssh "$DOKKU_HOST" ps:rebuild "$APP"
        else
            echo -e "${CYAN}Rebuilding '$APP'...${NC}"
            ssh "$DOKKU_HOST" ps:rebuild "$APP"
        fi
        echo -e "${GREEN}Rebuild complete!${NC}"
        ;;

    run)
        # Run one-off command
        shift
        APP=$(require_app "$1")
        shift
        [[ $# -eq 0 ]] && { echo "Usage: homelab run <app> <command>"; exit 1; }

        ssh "$DOKKU_HOST" run "$APP" "$@"
        ;;

    ps)
        # Show running processes
        shift
        APP=$(require_app "$1")
        ssh "$DOKKU_HOST" ps:report "$APP"
        ;;

    restart)
        # Restart app
        shift
        APP=$(require_app "$1")
        echo -e "${CYAN}Restarting '$APP'...${NC}"
        ssh "$DOKKU_HOST" ps:restart "$APP"
        echo -e "${GREEN}Restarted!${NC}"
        ;;

    stop)
        # Stop app
        shift
        APP=$(require_app "$1")
        echo -e "${YELLOW}Stopping '$APP'...${NC}"
        ssh "$DOKKU_HOST" ps:stop "$APP"
        ;;

    start)
        # Start app
        shift
        APP=$(require_app "$1")
        echo -e "${CYAN}Starting '$APP'...${NC}"
        ssh "$DOKKU_HOST" ps:start "$APP"
        ;;

    destroy|delete)
        # Destroy app
        shift
        APP="${1:?Error: app name required}"

        echo -e "${RED}This will permanently destroy '$APP' and all its data.${NC}"
        read -p "Type the app name to confirm: " CONFIRM

        if [[ "$CONFIRM" == "$APP" ]]; then
            ssh "$DOKKU_HOST" apps:destroy "$APP" --force
            # Remove git remote if it exists
            if git remote | grep -q "^dokku$" 2>/dev/null; then
                git remote remove dokku
                echo -e "${YELLOW}Removed 'dokku' git remote${NC}"
            fi
            echo -e "${GREEN}App '$APP' destroyed${NC}"
        else
            echo -e "${YELLOW}Aborted${NC}"
            exit 1
        fi
        ;;

    domains)
        # Show domains
        shift
        APP=$(require_app "$1")
        ssh "$DOKKU_HOST" domains:report "$APP"
        ;;

    url|open)
        # Show/open app URL
        shift
        APP=$(require_app "$1")
        URL=$(app_url "$APP")
        echo "$URL"

        # Open in browser if 'open' command
        if [[ "${BASH_SOURCE[0]##*/}" == "open" ]] || [[ "$1" == "--open" ]]; then
            open "$URL" 2>/dev/null || xdg-open "$URL" 2>/dev/null || echo "Open: $URL"
        fi
        ;;

    ssh|shell)
        # Interactive dokku shell
        ssh -t "$DOKKU_HOST" shell
        ;;

    dokku)
        # Pass-through to dokku
        shift
        ssh "$DOKKU_HOST" "$@"
        ;;

    # =========================================================================
    # HTTPS Commands
    # =========================================================================
    https:setup)
        # Set up HTTPS with Let's Encrypt
        require_server
        "$SCRIPT_DIR/setup-https.sh"
        ;;

    https:status)
        # Show HTTPS status
        require_server
        echo -e "${CYAN}HTTPS Status${NC}"
        echo ""
        if [[ -f "$SCRIPT_DIR/dokku/certs/server.crt" ]]; then
            echo -e "${GREEN}✓ HTTPS is configured${NC}"
            echo ""
            # Show cert info
            CERT_INFO=$(openssl x509 -in "$SCRIPT_DIR/dokku/certs/server.crt" -noout -subject -dates 2>/dev/null)
            echo "Certificate:"
            echo "$CERT_INFO" | sed 's/^/  /'
        else
            echo -e "${YELLOW}✗ HTTPS is not configured${NC}"
            echo ""
            echo "Run 'homelab https:setup' to configure HTTPS"
        fi
        ;;

    https:renew)
        # Manually renew certificates
        require_server
        "$SCRIPT_DIR/renew-certs.sh"
        ;;

    https:enable)
        # Enable HTTPS for a specific app
        require_server
        shift
        APP=$(require_app "$1")
        CERT_DIR="$SCRIPT_DIR/dokku/certs"

        if [[ ! -f "$CERT_DIR/server.crt" ]]; then
            echo -e "${RED}Error: No certificates found. Run 'homelab https:setup' first${NC}"
            exit 1
        fi

        echo -e "${CYAN}Enabling HTTPS for '$APP'...${NC}"
        cd "$CERT_DIR"
        tar cf - server.crt server.key | docker exec -i dokku dokku certs:add "$APP" 2>&1 | grep -v "^a " || true
        echo -e "${GREEN}HTTPS enabled for $APP${NC}"
        ;;

    # =========================================================================
    # Public Access Commands (Cloudflare Tunnel)
    # =========================================================================
    tunnel:setup)
        # Set up Cloudflare Tunnel
        require_server
        "$SCRIPT_DIR/setup-tunnel.sh"
        ;;

    public)
        # Make an app public
        require_server
        shift
        APP="${1:?Error: app name required}"
        HOSTNAME="${2:-$APP.$DOKKU_DOMAIN}"

        if [[ ! -f "$SCRIPT_DIR/setup-tunnel.sh" ]]; then
            echo -e "${RED}Error: Tunnel not set up. Run 'homelab tunnel:setup' first${NC}"
            exit 1
        fi

        # Check if tunnel is configured
        if [[ ! -f "$HOME/.cloudflared/config.yml" ]]; then
            echo -e "${YELLOW}Cloudflare Tunnel not configured. Setting up...${NC}"
            "$SCRIPT_DIR/setup-tunnel.sh"
        fi

        "$SCRIPT_DIR/tunnel-add-app.sh" "$APP" "$HOSTNAME"

        # Restart tunnel
        sudo launchctl kickstart -k system/com.homelab.tunnel 2>/dev/null || {
            sudo launchctl load /Library/LaunchDaemons/com.homelab.tunnel.plist 2>/dev/null || true
        }
        ;;

    private)
        # Make an app private (remove from public)
        require_server
        shift
        APP="${1:?Error: app name required}"

        "$SCRIPT_DIR/tunnel-remove-app.sh" "$APP"

        # Restart tunnel if it's running
        sudo launchctl kickstart -k system/com.homelab.tunnel 2>/dev/null || true
        ;;

    public:list)
        # List public apps
        require_server
        "$SCRIPT_DIR/tunnel-list-apps.sh"
        ;;

    tunnel:status)
        # Show tunnel status
        require_server
        echo -e "${CYAN}Cloudflare Tunnel Status${NC}"
        echo ""
        if [[ -f "$HOME/.cloudflared/config.yml" ]]; then
            echo -e "${GREEN}✓ Tunnel is configured${NC}"
            echo ""

            # Check if running
            if sudo launchctl list | grep -q "com.homelab.tunnel"; then
                echo -e "Status: ${GREEN}Running${NC}"
            else
                echo -e "Status: ${YELLOW}Stopped${NC}"
            fi
            echo ""

            # Show public apps
            "$SCRIPT_DIR/tunnel-list-apps.sh"
        else
            echo -e "${YELLOW}✗ Tunnel is not configured${NC}"
            echo ""
            echo "Run 'homelab tunnel:setup' to configure"
        fi
        ;;

    tunnel:restart)
        # Restart the tunnel
        require_server
        echo -e "${CYAN}Restarting Cloudflare Tunnel...${NC}"
        sudo launchctl kickstart -k system/com.homelab.tunnel 2>/dev/null || {
            sudo launchctl load /Library/LaunchDaemons/com.homelab.tunnel.plist
        }
        echo -e "${GREEN}Tunnel restarted${NC}"
        ;;

    tunnel:logs)
        # View tunnel logs
        require_server
        if [[ "$2" == "-f" || "$2" == "--follow" ]]; then
            tail -f /tmp/homelab-tunnel.log
        else
            cat /tmp/homelab-tunnel.log
        fi
        ;;

    # =========================================================================
    # Circuit Breaker Commands
    # =========================================================================
    circuit-breaker:status|cb:status)
        # Show circuit breaker status
        require_server
        "$SCRIPT_DIR/circuit-breaker.sh" status
        ;;

    circuit-breaker:restore|cb:restore)
        # Restore apps disabled by circuit breaker
        require_server
        "$SCRIPT_DIR/circuit-breaker.sh" restore
        ;;

    circuit-breaker:logs|cb:logs)
        # View circuit breaker logs
        require_server
        "$SCRIPT_DIR/circuit-breaker.sh" logs
        ;;

    circuit-breaker:test|cb:test)
        # Test the circuit breaker (will trip immediately)
        require_server
        "$SCRIPT_DIR/circuit-breaker.sh" test
        ;;

    circuit-breaker:enable|cb:enable)
        # Enable the circuit breaker daemon
        require_server
        echo -e "${CYAN}Enabling circuit breaker...${NC}"

        # Create launchd plist
        sudo tee /Library/LaunchDaemons/com.homelab.circuitbreaker.plist > /dev/null << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.homelab.circuitbreaker</string>
    <key>ProgramArguments</key>
    <array>
        <string>${SCRIPT_DIR}/circuit-breaker.sh</string>
        <string>check</string>
    </array>
    <key>StartInterval</key>
    <integer>60</integer>
    <key>StandardOutPath</key>
    <string>/tmp/homelab-circuitbreaker.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/homelab-circuitbreaker.log</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>${HOME}</string>
        <key>PATH</key>
        <string>/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin</string>
    </dict>
</dict>
</plist>
PLIST

        sudo launchctl unload /Library/LaunchDaemons/com.homelab.circuitbreaker.plist 2>/dev/null || true
        sudo launchctl load /Library/LaunchDaemons/com.homelab.circuitbreaker.plist
        echo -e "${GREEN}Circuit breaker enabled (checks every 60 seconds)${NC}"
        ;;

    circuit-breaker:disable|cb:disable)
        # Disable the circuit breaker daemon
        require_server
        echo -e "${YELLOW}Disabling circuit breaker...${NC}"
        sudo launchctl unload /Library/LaunchDaemons/com.homelab.circuitbreaker.plist 2>/dev/null || true
        echo -e "${GREEN}Circuit breaker disabled${NC}"
        ;;

    # =========================================================================
    # Database Commands
    # =========================================================================
    db:create)
        # Create and link a Dokku postgres database
        require_server
        shift
        APP="${1:?Error: app name required}"
        SERVICE="${2:-${APP}-db}"

        echo -e "${CYAN}Creating postgres service '$SERVICE'...${NC}"
        ssh "$DOKKU_HOST" postgres:create "$SERVICE"

        echo -e "${CYAN}Linking '$SERVICE' to app '$APP'...${NC}"
        ssh "$DOKKU_HOST" postgres:link "$SERVICE" "$APP"

        echo -e "${GREEN}Database '$SERVICE' created and linked to '$APP'${NC}"
        echo -e "View info: ${CYAN}homelab db:info $SERVICE${NC}"
        ;;

    db:info)
        # Show database info
        require_server
        shift
        SERVICE="${1:?Error: service name required}"
        ssh "$DOKKU_HOST" postgres:info "$SERVICE"
        ;;

    db:backup)
        # Run a manual database backup to R2
        require_server
        shift
        SERVICE="${1:-nextcloud-db}"
        echo -e "${CYAN}Backing up '$SERVICE' to R2...${NC}"
        "$SCRIPT_DIR/nextcloud-backup.sh" "$SERVICE"
        ;;

    db:backup:schedule)
        # Schedule daily database backups via launchd
        require_server
        shift
        SERVICE="${1:-nextcloud-db}"
        echo -e "${CYAN}Scheduling daily backup for '$SERVICE' at 3:00 AM...${NC}"

        sudo tee /Library/LaunchDaemons/com.homelab.db-backup.plist > /dev/null << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.homelab.db-backup</string>
    <key>ProgramArguments</key>
    <array>
        <string>${SCRIPT_DIR}/nextcloud-backup.sh</string>
        <string>${SERVICE}</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>3</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>
    <key>StandardOutPath</key>
    <string>/tmp/homelab-db-backup.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/homelab-db-backup.log</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>${HOME}</string>
        <key>PATH</key>
        <string>/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin</string>
    </dict>
</dict>
</plist>
PLIST

        sudo launchctl unload /Library/LaunchDaemons/com.homelab.db-backup.plist 2>/dev/null || true
        sudo launchctl load /Library/LaunchDaemons/com.homelab.db-backup.plist
        echo -e "${GREEN}Daily backup scheduled for '$SERVICE' at 3:00 AM${NC}"
        ;;

    # =========================================================================
    # Update Command
    # =========================================================================
    update)
        # Update the homelab CLI
        echo -e "${CYAN}Updating homelab CLI...${NC}"

        # Detect if we're running on the server or a standalone client install
        if is_server; then
            # Running on the server
            echo "Pulling latest changes..."
            cd "$SCRIPT_DIR"
            git pull
            echo -e "${GREEN}Updated from git repository${NC}"
        else
            # Standalone install (client)
            echo "Downloading latest version..."
            INSTALL_PATH="${BASH_SOURCE[0]}"
            curl -fsSL -o "$INSTALL_PATH.tmp" https://raw.githubusercontent.com/mrilikecoding/homelab/main/homelab
            if [[ -s "$INSTALL_PATH.tmp" ]]; then
                mv "$INSTALL_PATH.tmp" "$INSTALL_PATH"
                chmod +x "$INSTALL_PATH"
                echo -e "${GREEN}Updated successfully${NC}"
            else
                rm -f "$INSTALL_PATH.tmp"
                echo -e "${RED}Update failed - could not download${NC}"
                exit 1
            fi
        fi
        ;;

    client:reset)
        # Remove server-specific artifacts from this machine
        echo -e "${CYAN}Homelab Client Reset${NC}"
        echo ""
        echo "This will remove server-specific config from this machine."
        echo ""

        # Collect artifacts that exist
        ARTIFACTS=()

        # LaunchDaemons
        PLISTS=(/Library/LaunchDaemons/com.homelab.*.plist)
        if [[ -e "${PLISTS[0]}" ]]; then
            for plist in "${PLISTS[@]}"; do
                ARTIFACTS+=("LaunchDaemon: $plist")
            done
        fi

        # Startup script
        if [[ -f /usr/local/bin/homelab-startup.sh ]]; then
            ARTIFACTS+=("Startup script: /usr/local/bin/homelab-startup.sh")
        fi

        # Config file
        if [[ -f "$SCRIPT_DIR/config.sh" ]]; then
            ARTIFACTS+=("Config file: $SCRIPT_DIR/config.sh")
        fi

        # Env file
        if [[ -f "$SCRIPT_DIR/.env" ]]; then
            ARTIFACTS+=("Env file: $SCRIPT_DIR/.env")
        fi

        # Public apps list
        if [[ -f "$SCRIPT_DIR/.public-apps" ]]; then
            ARTIFACTS+=("Public apps list: $SCRIPT_DIR/.public-apps")
        fi

        # Certs
        if [[ -f "$SCRIPT_DIR/dokku/certs/server.crt" ]] || [[ -f "$SCRIPT_DIR/dokku/certs/server.key" ]]; then
            ARTIFACTS+=("Certs: $SCRIPT_DIR/dokku/certs/server.{crt,key}")
        fi

        # Homelab config dir
        if [[ -d "$HOME/.homelab" ]]; then
            ARTIFACTS+=("Homelab config dir: ~/.homelab/")
        fi

        # Cloudflared config
        if [[ -d "$HOME/.cloudflared" ]]; then
            ARTIFACTS+=("Cloudflared config: ~/.cloudflared/")
        fi

        # Server marker
        if [[ -f "$SCRIPT_DIR/.homelab-server" ]]; then
            ARTIFACTS+=("Server marker: $SCRIPT_DIR/.homelab-server")
        fi

        if [[ ${#ARTIFACTS[@]} -eq 0 ]]; then
            echo -e "${GREEN}No server artifacts found — this machine is already a clean client.${NC}"
            exit 0
        fi

        echo -e "${YELLOW}The following will be removed:${NC}"
        for item in "${ARTIFACTS[@]}"; do
            echo "  - $item"
        done
        echo ""

        read -p "Proceed? [y/N] " CONFIRM
        [[ "$CONFIRM" =~ ^[yY]$ ]] || { echo -e "${YELLOW}Aborted${NC}"; exit 1; }

        echo ""

        # Remove LaunchDaemons
        if [[ -e "${PLISTS[0]}" ]]; then
            for plist in "${PLISTS[@]}"; do
                label=$(basename "$plist" .plist)
                echo "Unloading $label..."
                sudo launchctl unload "$plist" 2>/dev/null || true
                sudo rm -f "$plist"
            done
        fi

        # Remove startup script
        if [[ -f /usr/local/bin/homelab-startup.sh ]]; then
            echo "Removing startup script..."
            sudo rm -f /usr/local/bin/homelab-startup.sh
        fi

        # Remove config file
        if [[ -f "$SCRIPT_DIR/config.sh" ]]; then
            echo "Removing config.sh..."
            rm -f "$SCRIPT_DIR/config.sh"
        fi

        # Remove env file
        if [[ -f "$SCRIPT_DIR/.env" ]]; then
            echo "Removing .env..."
            rm -f "$SCRIPT_DIR/.env"
        fi

        # Remove public apps list
        if [[ -f "$SCRIPT_DIR/.public-apps" ]]; then
            echo "Removing .public-apps..."
            rm -f "$SCRIPT_DIR/.public-apps"
        fi

        # Remove certs
        rm -f "$SCRIPT_DIR/dokku/certs/server.crt" "$SCRIPT_DIR/dokku/certs/server.key" 2>/dev/null

        # Remove homelab config dir
        if [[ -d "$HOME/.homelab" ]]; then
            echo "Removing ~/.homelab/..."
            rm -rf "$HOME/.homelab"
        fi

        # Remove cloudflared config
        if [[ -d "$HOME/.cloudflared" ]]; then
            echo "Removing ~/.cloudflared/..."
            rm -rf "$HOME/.cloudflared"
        fi

        # Remove server marker
        if [[ -f "$SCRIPT_DIR/.homelab-server" ]]; then
            echo "Removing server marker..."
            rm -f "$SCRIPT_DIR/.homelab-server"
        fi

        echo ""
        echo -e "${GREEN}Client reset complete.${NC}"

        # Hint about manual steps if Docker/Colima are present
        MANUAL_STEPS=false
        if command -v colima &>/dev/null && colima status 2>/dev/null | grep -q "Running"; then
            MANUAL_STEPS=true
        fi
        if command -v docker &>/dev/null && docker ps -q 2>/dev/null | grep -q .; then
            MANUAL_STEPS=true
        fi

        if [[ "$MANUAL_STEPS" == true ]]; then
            echo ""
            echo -e "${YELLOW}Note:${NC} Docker containers and Colima were left untouched."
            echo "To fully clean up, you may also want to:"
            echo "  - Stop Docker containers: docker stop \$(docker ps -q)"
            echo "  - Delete the Colima VM:   colima delete"
        fi
        ;;

    help|--help|-h|"")
        cat <<EOF
${CYAN}Homelab CLI${NC} - Heroku-like interface for Dokku

${GREEN}Usage:${NC} homelab <command> [options]

${GREEN}App Management:${NC}
  apps                    List all apps
  create <name>           Create a new app (adds git remote)
  destroy <name>          Permanently delete an app

${GREEN}Deployment:${NC}
  deploy [name] [--create]  Deploy app (auto-detects from git remote)
  deploy [name] -b <branch> Deploy specific branch

${GREEN}Runtime:${NC}
  logs [name] [-t]        View logs (-t to tail/follow)
  ps [name]               Show running processes
  run <name> <cmd>        Run one-off command
  restart [name]          Restart app
  stop [name]             Stop app
  start [name]            Start app

${GREEN}Configuration:${NC}
  config [name]           Show config vars
  config:set <name> K=V   Set config vars
  config:unset <name> K   Unset config vars
  domains [name]          Show domains

${GREEN}Build Args (for static sites):${NC}
  build-args [name]       List build args
  build-args:set <name> K Add build arg (injects config var at build time)
  build-args:unset <name> K  Remove build arg
  rebuild [name]          Force rebuild
  rebuild [name] --no-cache  Rebuild and bust Docker cache

${GREEN}HTTPS (server only):${NC}
  https:setup             Set up HTTPS with Let's Encrypt
  https:status            Show certificate status
  https:enable [app]      Enable HTTPS for an app
  https:renew             Manually renew certificates

${GREEN}Public Access (server only):${NC}
  tunnel:setup            Set up Cloudflare Tunnel
  public <app> [host]     Make app public (optional custom hostname)
  private <app>           Make app private again
  public:list             List all public apps
  tunnel:status           Show tunnel status
  tunnel:restart          Restart the tunnel
  tunnel:logs [-f]        View tunnel logs

${GREEN}Circuit Breaker (server only):${NC}
  cb:enable               Enable auto-protection (checks every 60s)
  cb:disable              Disable auto-protection
  cb:status               Show current load and thresholds
  cb:restore              Re-enable apps disabled by circuit breaker
  cb:logs                 View circuit breaker logs
  cb:test                 Test the circuit breaker (will trip!)

${GREEN}Database (server only):${NC}
  db:create <app> [service]  Create and link a postgres database
  db:info <service>          Show database info
  db:backup [service]        Run a manual backup to R2
  db:backup:schedule [svc]   Schedule daily backups at 3 AM

${GREEN}Utilities:${NC}
  url [name]              Show app URL
  ssh                     Interactive dokku shell
  dokku <cmd>             Pass-through to dokku
  update                  Update the homelab CLI
  client:reset            Remove server config from this machine

${GREEN}Examples:${NC}
  homelab create myapp           # Create app, add git remote
  homelab deploy                 # Deploy (auto-detects app)
  homelab deploy myapp --create  # Create + deploy in one step
  homelab logs myapp -t          # Tail logs
  homelab config:set myapp DEBUG=true
  homelab run myapp bash         # Interactive shell in container

${GREEN}Static Site Build Args:${NC}
  homelab config:set myapp PUBLIC_API_URL=https://api.example.com
  homelab build-args:set myapp PUBLIC_API_URL
  homelab rebuild myapp          # Rebuilds with env var baked in

${GREEN}HTTPS & Public Access Examples:${NC}
  homelab https:setup            # Set up wildcard cert (interactive)
  homelab public myapp           # Make public at myapp.yourdomain.com
  homelab public myapp api.yourdomain.com  # Custom public hostname
  homelab private myapp          # Remove from public access

${YELLOW}Note:${NC} Commands marked "server only" must be run on the homelab server.
All other commands work from any machine with the CLI installed.

EOF
        ;;

    *)
        echo -e "${RED}Unknown command: $1${NC}" >&2
        echo "Run 'homelab help' for usage" >&2
        exit 1
        ;;
esac
